# –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø –†–ï–ñ–ò–ú–ê –°–û–í–ú–ï–©–ï–ù–ò–Ø –õ–ò–î–ê–†–ê –ò –û–î–û–ú–ï–¢–†–ò–ò

## –û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### üö® **–ü—Ä–æ–±–ª–µ–º–∞ 1: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—è –∫–≤–∞—Ç–µ—Ä–Ω–∏–æ–Ω–æ–≤**
**–°–∏–º–ø—Ç–æ–º—ã:** –®—É–º—ã –ø–æ —É–≥–ª–∞–º, –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø–æ–≤–æ—Ä–æ—Ç—ã  
**–ü—Ä–∏—á–∏–Ω–∞:** –õ–∏–Ω–µ–π–Ω–∞—è –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—è –∫–≤–∞—Ç–µ—Ä–Ω–∏–æ–Ω–æ–≤ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ –∏—Å–∫–∞–∂–µ–Ω–∏—è–º —É–≥–ª–æ–≤

### üö® **–ü—Ä–æ–±–ª–µ–º–∞ 2: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–π**
**–°–∏–º–ø—Ç–æ–º—ã:** –°—Ä–µ–∑–∞–Ω–∏–µ –≤—ã—Å–æ—Ç—ã, –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç  
**–ü—Ä–∏—á–∏–Ω–∞:** –ù–µ–¥–æ—Å—Ç–∞—Ç–æ–∫ –ø—Ä–æ–≤–µ—Ä–æ–∫ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–π

### üö® **–ü—Ä–æ–±–ª–µ–º–∞ 3: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ —Å–º–µ—â–µ–Ω–∏—è –ª–∏–¥–∞—Ä–∞**
**–°–∏–º–ø—Ç–æ–º—ã:** –ù–µ—Ç–æ—á–Ω–æ–µ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ—á–µ–∫  
**–ü—Ä–∏—á–∏–Ω–∞:** –ù–µ —É—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è —Å–º–µ—â–µ–Ω–∏–µ –ª–∏–¥–∞—Ä–∞ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Ü–µ–Ω—Ç—Ä–∞ —Ä–æ–±–æ—Ç–∞

## –í–Ω–µ—Å–µ–Ω–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### ‚úÖ **1. –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è SLERP –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—è –∫–≤–∞—Ç–µ—Ä–Ω–∏–æ–Ω–æ–≤**

**–§–∞–π–ª:** `bag2las_transform.py`  
**–ß—Ç–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ:**
- –§—É–Ω–∫—Ü–∏—è `slerp_quaternions()` –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏–∏ –∫–≤–∞—Ç–µ—Ä–Ω–∏–æ–Ω–æ–≤
- –ó–∞–º–µ–Ω–∞ –ª–∏–Ω–µ–π–Ω–æ–π –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏–∏ –Ω–∞ SLERP –≤ `interpolate_odometry_data()`

**–ö–æ–¥:**
```python
def slerp_quaternions(q1, q2, t):
    """Spherical Linear Interpolation (SLERP) for quaternions."""
    # –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—è –∫–≤–∞—Ç–µ—Ä–Ω–∏–æ–Ω–æ–≤ —Å —É—á–µ—Ç–æ–º –∫—Ä–∞—Ç—á–∞–π—à–µ–≥–æ –ø—É—Ç–∏
    # –∏ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –≥—Ä–∞–Ω–∏—á–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ —à—É–º–æ–≤ –ø–æ —É–≥–ª–∞–º –∏ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –ø–æ–≤–æ—Ä–æ—Ç–æ–≤

### ‚úÖ **2. –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ —Å–º–µ—â–µ–Ω–∏—è –ª–∏–¥–∞—Ä–∞**

**–ß—Ç–æ —É–ª—É—á—à–µ–Ω–æ:**
- –†–∞—Å—à–∏—Ä–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `create_transform_matrix()` –¥–ª—è —É—á–µ—Ç–∞ —Å–º–µ—â–µ–Ω–∏—è –ª–∏–¥–∞—Ä–∞
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –∫–∞–∫ —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏–æ–Ω–Ω–æ–≥–æ, —Ç–∞–∫ –∏ —Ä–æ—Ç–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Å–º–µ—â–µ–Ω–∏—è

**–ö–æ–¥:**
```python
def create_transform_matrix(position, quaternion, lidar_offset=None):
    """
    Parameters:
        lidar_offset: Optional [x, y, z, rx, ry, rz] offset from robot base to lidar
    """
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ë–æ–ª–µ–µ —Ç–æ—á–Ω–æ–µ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ—á–µ–∫ —Å —É—á–µ—Ç–æ–º —Ä–µ–∞–ª—å–Ω–æ–≥–æ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏—è –ª–∏–¥–∞—Ä–∞ –Ω–∞ —Ä–æ–±–æ—Ç–µ

### ‚úÖ **3. –î–æ–±–∞–≤–ª–µ–Ω–∞ –≤—Å–µ—Å—Ç–æ—Ä–æ–Ω–Ω—è—è –≤–∞–ª–∏–¥–∞—Ü–∏—è —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–π**

**–ß—Ç–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ:**
- –§—É–Ω–∫—Ü–∏—è `validate_coordinate_systems()` –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–π
- –ü—Ä–æ–≤–µ—Ä–∫–∏ –≤ `apply_transform_to_points()` –¥–ª—è –≤—ã—è–≤–ª–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º

**–ü—Ä–æ–≤–µ—Ä–∫–∏ –≤–∫–ª—é—á–∞—é—Ç:**
- –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–µ—Ç–µ—Ä–º–∏–Ω–∞–Ω—Ç–∞ –º–∞—Ç—Ä–∏—Ü—ã —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏ (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å ~1.0)
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ NaN –∏ –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
- –ê–Ω–∞–ª–∏–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–∏—Å—Ç–∞–Ω—Ü–∏–π —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏
- –ö–æ–Ω—Ç—Ä–æ–ª—å –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–∏–∞–ø–∞–∑–æ–Ω–æ–≤ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
- –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤—ã—Å–æ—Ç—ã (Z)

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –†–∞–Ω–Ω–µ–µ –≤—ã—è–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º —Å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–Ω—ã–º–∏ —Å–∏—Å—Ç–µ–º–∞–º–∏

### ‚úÖ **4. –£–ª—É—á—à–µ–Ω–Ω—ã–µ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è**

**–ß—Ç–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ:**
- –ü–æ–¥—Ä–æ–±–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∫–∞–∂–¥–æ–π —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏
- –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –æ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º–∞—Ö
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç

## –ö–∞–∫ —ç—Ç–æ –∏—Å–ø—Ä–∞–≤–ª—è–µ—Ç –∏—Å—Ö–æ–¥–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### ‚ùå **"–°—Ä–µ–∑–∞–µ—Ç –≤—ã—Å–æ—Ç—É"**
**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:**
- –í–∞–ª–∏–¥–∞—Ü–∏—è —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ –æ—Å–∏ Z
- –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –ø—Ä–∏ –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö –≤—ã—Å–æ—Ç—ã (>2–º)
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–µ—Ç–µ—Ä–º–∏–Ω–∞–Ω—Ç–∞ –º–∞—Ç—Ä–∏—Ü—ã –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ

### ‚ùå **"–î–æ–±–∞–≤–ª—è–µ—Ç —à—É–º—ã –ø–æ —É–≥–ª–∞–º"** 
**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:**
- SLERP –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—è –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –ø–ª–∞–≤–Ω—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—ã —É–≥–ª–æ–≤
- –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –∫–≤–∞—Ç–µ—Ä–Ω–∏–æ–Ω–æ–≤ –ø–æ—Å–ª–µ –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏–∏
- –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≥—Ä–∞–Ω–∏—á–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —É–ª—É—á—à–µ–Ω–∏–π

### –ë–∞–∑–æ–≤–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ (–∫–∞–∫ —Ä–∞–Ω—å—à–µ):
```python
# –í—Å–µ —É–ª—É—á—à–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
convert_bag_to_laz(bag_file, output_dir, transform_mode="global")
```

### –†–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å —Å–º–µ—â–µ–Ω–∏–µ–º –ª–∏–¥–∞—Ä–∞:
```python
# –ï—Å–ª–∏ –Ω—É–∂–Ω–æ —É—á–µ—Å—Ç—å —Å–º–µ—â–µ–Ω–∏–µ –ª–∏–¥–∞—Ä–∞ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Ä–æ–±–æ—Ç–∞
# –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä—É–π—Ç–µ create_transform_matrix –≤ –∫–æ–¥–µ:
lidar_offset = [0.1, 0.0, 0.5, 0.0, 0.0, 0.0]  # x,y,z,rx,ry,rz
transform_matrix = create_transform_matrix(position, quaternion, lidar_offset)
```

## –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

1. **–£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ —à—É–º–æ–≤ –ø–æ —É–≥–ª–∞–º** - –ø–ª–∞–≤–Ω—ã–µ –ø–æ–≤–æ—Ä–æ—Ç—ã –±–ª–∞–≥–æ–¥–∞—Ä—è SLERP
2. **–ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã—Å–æ—Ç—ã** - –≤–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è Z
3. **–†–∞–Ω–Ω–µ–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º** - –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –≤—ã—è–≤–ª—è–µ—Ç –ø—Ä–æ–±–ª–µ–º—ã –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–Ω—ã—Ö —Å–∏—Å—Ç–µ–º
4. **–ë–æ–ª–µ–µ —Ç–æ—á–Ω–æ–µ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ** - —É—á–µ—Ç —Å–º–µ—â–µ–Ω–∏—è –ª–∏–¥–∞—Ä–∞
5. **–õ—É—á—à–∞—è –æ—Ç–ª–∞–¥–∫–∞** - –ø–æ–¥—Ä–æ–±–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ –ø—Ä–æ—Ü–µ—Å—Å–µ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏

## –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å

–í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –æ–±—Ä–∞—Ç–Ω–æ —Å–æ–≤–º–µ—Å—Ç–∏–º—ã - —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –∫–∞–∫ —Ä–∞–Ω—å—à–µ, –Ω–æ —Å —É–ª—É—á—à–µ–Ω–Ω—ã–º –∫–∞—á–µ—Å—Ç–≤–æ–º —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–π.