# Трансформация облаков точек с использованием данных одометрии

## Обзор

Обновленная версия `bag2las_transform.py` добавляет возможность трансформации облаков точек относительно данных одометрии. Это позволяет получить облака точек в различных системах координат для более удобного анализа и визуализации.

## Новые возможности

### Режимы трансформации

1. **Без трансформации (`none`)**
   - Сохраняет оригинальные координаты из сенсора
   - Аналогично поведению оригинальной версии
   - Используется по умолчанию, если нет данных одометрии

2. **Глобальная система координат (`global`)**
   - Трансформирует точки в глобальную систему координат одометрии
   - Каждый скан позиционируется согласно данным одометрии
   - Полезно для создания карт и анализа траектории

3. **Локальная система координат (`local`)**
   - Трансформирует все точки относительно позиции первого скана
   - Первый скан остается в центре координат (0,0,0)
   - Удобно для анализа относительного движения

### Требования к данным

Для использования трансформации необходимо:

- **Топик PointCloud2**: основные данные облака точек
- **Топик Odometry**: данные о позиции и ориентации робота
- **Временная синхронизация**: топики должны иметь перекрывающиеся временные метки

## Технические детали

### Алгоритм трансформации

1. **Сбор данных одометрии**: загрузка всех сообщений из выбранного топика одометрии
2. **Временная синхронизация**: интерполяция данных одометрии для каждого сообщения PointCloud2
3. **Вычисление трансформаций**: создание матриц гомогенных трансформаций из позиции и кватерниона
4. **Применение трансформации**: преобразование координат каждой точки

### Интерполяция данных

- Используется линейная интерполяция для позиции (x, y, z)
- Для кватернионов применяется линейная интерполяция с последующей нормализацией
- Обрабатываются случаи отсутствия временного перекрытия

### Обработка ошибок

- Автоматическое переключение на режим "без трансформации" при проблемах с данными одометрии
- Детальная диагностика временных диапазонов и качества данных
- Проверка корректности интерполяции

## Использование

### Интерактивный режим

При запуске программа автоматически:
1. Сканирует bag-файл на наличие топиков PointCloud2 и Odometry
2. Предлагает выбрать топики для обработки
3. Показывает меню выбора режима трансформации
4. Выполняет обработку с выбранными параметрами

### Программный интерфейс

```python
# Без трансформации (по умолчанию)
convert_bag_to_laz(bag_file, output_dir, topic, transform_mode="none")

# Глобальная система координат
convert_bag_to_laz(bag_file, output_dir, topic, transform_mode="global")

# Локальная система координат
convert_bag_to_laz(bag_file, output_dir, topic, transform_mode="local")

# Автоматический выбор пользователем
convert_bag_to_laz(bag_file, output_dir, topic, transform_mode=None)
```

## Примеры применения

### 1. Создание карты окружения
Используйте режим `global` для создания карты:
- Все сканы будут расположены согласно траектории робота
- Получится связная карта окружения
- Удобно для анализа пройденного пути

### 2. Анализ движения робота
Используйте режим `local` для анализа движения:
- Все сканы позиционированы относительно начальной точки
- Легко увидеть траекторию движения
- Полезно для отладки алгоритмов навигации

### 3. Обработка статических сцен
Используйте режим `none` для статических объектов:
- Сохраняются оригинальные координаты сенсора
- Минимальная обработка данных
- Максимальная точность измерений

## Диагностика и отладка

### Анализ временной синхронизации

Программа выводит подробную информацию о:
- Временных диапазонах топиков
- Качестве интерполяции
- Области временного перекрытия

### Проверка результатов

В выходных данных указывается:
- Примененный режим трансформации
- Количество трансформированных точек
- Статистика координат до и после трансформации

### Типичные проблемы

1. **Нет временного перекрытия**
   - Проверьте синхронизацию часов
   - Убедитесь, что топики записывались одновременно

2. **Плохое качество одометрии**
   - Проверьте частоту публикации одометрии
   - Убедитесь в корректности данных позиции

3. **Большие скачки координат**
   - Может указывать на ошибки в одометрии
   - Проверьте калибровку датчиков

## Выходные файлы

Помимо основного LAS-файла создаются:
- **POS-файл**: траектория робота в формате GPS_Time X Y Z Roll Pitch Yaw
- **Отчет**: подробная информация о процессе трансформации

## Зависимости

Новые зависимости для трансформации:
```bash
pip install scipy  # для интерполяции данных
```

Остальные зависимости остались прежними:
- numpy
- laspy  
- rosbag (часть ROS)
- sensor_msgs

## Производительность

- Двухпроходная обработка увеличивает время выполнения примерно на 30%
- Потребление памяти увеличивается для хранения промежуточных данных
- Время интерполяции зависит от количества сообщений одометрии

## Совместимость

- Полная обратная совместимость с оригинальной версией
- Поддержка всех существующих форматов LAS
- Работа с любыми топиками PointCloud2 и Odometry

---

*Для вопросов и предложений создайте issue в репозитории проекта.*