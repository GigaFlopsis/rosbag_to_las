# –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –ü–æ–∑–∏—Ü–∏–π –ö–∞–º–µ—Ä—ã –∏–∑ ROS Bag

## –û–ø–∏—Å–∞–Ω–∏–µ

–°–∫—Ä–∏–ø—Ç `extract_camera_positions.py` –∏–∑–≤–ª–µ–∫–∞–µ—Ç –ø–æ–∑–∏—Ü–∏–∏ –∫–∞–º–µ—Ä—ã –∏–∑ ROS bag —Ñ–∞–π–ª–æ–≤ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ —Ñ–æ—Ç–æ–≥—Ä–∞–º–º–µ—Ç—Ä–∏—á–µ—Å–∫–æ–º –ü–û (Agisoft Metashape, Pix4D –∏ –¥—Ä.).

## –ß—Ç–æ –∏–∑–≤–ª–µ–∫–∞–µ—Ç—Å—è

### –ò—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–∞–Ω–Ω—ã—Ö:
1. **`/mavros/cam_imu_sync/cam_imu_stamp`** - —Ç–æ—á–Ω–æ–µ –≤—Ä–µ–º—è —Å—ä—ë–º–∫–∏ –∫–∞–¥—Ä–∞
   - `frame_stamp` - –º–µ—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è –∑–∞—Ç–≤–æ—Ä–∞
   - `frame_seq_id` - –ø–æ—Ä—è–¥–∫–æ–≤—ã–π –Ω–æ–º–µ—Ä –∫–∞–¥—Ä–∞

2. **`/mavros/statustext/send`** - –∏–º–µ–Ω–∞ —Ñ–∞–π–ª–æ–≤ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π
   - –§–∏–ª—å—Ç—Ä—É—é—Ç—Å—è —Ç–æ–ª—å–∫–æ —Å–æ–æ–±—â–µ–Ω–∏—è —Å `[PHOTO]:`
   - –§–æ—Ä–º–∞—Ç: `[PHOTO]: image_20250919_175100_691924_seq1000.jpg`

3. **`/mavros/local_position/odom`** - –ø–æ–∑–∏—Ü–∏—è –∏ –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è –¥—Ä–æ–Ω–∞
   - Position (x, y, z)
   - Orientation (quaternion: qx, qy, qz, qw)

## –í—ã—Ö–æ–¥–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã

### 1. CSV (—É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π)
```csv
timestamp,seq_id,filename,x,y,z,qx,qy,qz,qw
1758293459.946,1000,image_20250919_175100_691924_seq1000.jpg,1.234,5.678,2.345,0.1,0.2,0.3,0.9
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
- –ò–º–ø–æ—Ä—Ç –≤ Excel/LibreOffice
- –ê–Ω–∞–ª–∏–∑ –≤ Python/R
- –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ–±–º–µ–Ω–∞

### 2. JSON (—Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π)
```json
{
  "metadata": {
    "bag_file": "./test.bag",
    "export_time": "2025-10-11T14:30:00",
    "total_frames": 2
  },
  "frames": [
    {
      "timestamp": 1758293459.946,
      "seq_id": 1000,
      "filename": "image_20250919_175100_691924_seq1000.jpg",
      "x": 1.234,
      "y": 5.678,
      "z": 2.345,
      "qx": 0.1,
      "qy": 0.2,
      "qz": 0.3,
      "qw": 0.9
    }
  ]
}
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
- –ü—Ä–æ–≥—Ä–∞–º–º–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞
- Web-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
- API –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è

### 3. Agisoft TXT (—Ñ–æ—Ç–æ–≥—Ä–∞–º–º–µ—Ç—Ä–∏—è)
```
# Camera positions from ROS bag
# Format: filename x y z qx qy qz qw
#
image_20250919_175100_691924_seq1000.jpg 1.234000 5.678000 2.345000 0.100000 0.200000 0.300000 0.900000
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
- –ü—Ä—è–º–æ–π –∏–º–ø–æ—Ä—Ç –≤ Agisoft Metashape
- Pix4D
- OpenDroneMap

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –ë–∞–∑–æ–≤—ã–π –∑–∞–ø—É—Å–∫:

```bash
python3 extract_camera_positions.py
```

### –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π —Ä–µ–∂–∏–º:

```
üìÅ –í–≤–µ–¥–∏—Ç–µ –ø—É—Ç—å –∫ ROS bag —Ñ–∞–π–ª—É: ./test.bag

üìù –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ä–º–∞—Ç—ã –≤—ã–≤–æ–¥–∞:
   1 - CSV (—É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π)
   2 - JSON (—Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π)
   3 - Agisoft TXT (–¥–ª—è —Ñ–æ—Ç–æ–≥—Ä–∞–º–º–µ—Ç—Ä–∏–∏)
   4 - –í—Å–µ —Ñ–æ—Ä–º–∞—Ç—ã

–í—ã–±–æ—Ä (Enter –¥–ª—è CSV): 4

üìÅ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è (Enter –¥–ª—è —Ç–µ–∫—É—â–µ–π): 
```

### –ü—Ä–æ–≥—Ä–∞–º–º–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:

```python
from extract_camera_positions import CameraPositionExtractor

# –°–æ–∑–¥–∞—Ç—å —ç–∫—Å—Ç—Ä–∞–∫—Ç–æ—Ä
extractor = CameraPositionExtractor('path/to/file.bag')

# –û–±—Ä–∞–±–æ—Ç–∞—Ç—å –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å
positions = extractor.process(
    output_formats=['csv', 'json', 'agisoft'],
    output_dir='./output'
)

# –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤—Ä—É—á–Ω—É—é
extractor.extract_data()
extractor.match_frames_with_filenames()
extractor.interpolate_positions()
extractor.save_to_csv('output.csv')
```

## –ê–ª–≥–æ—Ä–∏—Ç–º —Ä–∞–±–æ—Ç—ã

### 1. –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
- –ß–∏—Ç–∞–µ—Ç –≤—Å–µ —Ç–æ–ø–∏–∫–∏ –∫–∞–º–µ—Ä—ã –∏ –æ–¥–æ–º–µ—Ç—Ä–∏–∏
- –°–æ–±–∏—Ä–∞–µ—Ç –º–µ—Ç–∫–∏ –≤—Ä–µ–º–µ–Ω–∏ –∫–∞–¥—Ä–æ–≤
- –§–∏–ª—å—Ç—Ä—É–µ—Ç –∏–º–µ–Ω–∞ —Ñ–∞–π–ª–æ–≤ (—Ç–æ–ª—å–∫–æ `[PHOTO]:`)
- –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏—é –æ–¥–æ–º–µ—Ç—Ä–∏–∏

### 2. –°–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –∫–∞–¥—Ä–æ–≤ —Å —Ñ–∞–π–ª–∞–º–∏
- –ù–∞—Ö–æ–¥–∏—Ç –±–ª–∏–∂–∞–π—à–µ–µ –∏–º—è —Ñ–∞–π–ª–∞ –¥–ª—è –∫–∞–∂–¥–æ–π –º–µ—Ç–∫–∏ –≤—Ä–µ–º–µ–Ω–∏ –∫–∞–º–µ—Ä—ã
- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Ä–∞–∑–Ω–∏—Ü–∞: 1 —Å–µ–∫—É–Ω–¥–∞ (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è)
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è

### 3. –ò–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—è –ø–æ–∑–∏—Ü–∏–π
- –õ–∏–Ω–µ–π–Ω–∞—è –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—è –ø–æ–∑–∏—Ü–∏–∏ (x, y, z)
- –õ–∏–Ω–µ–π–Ω–∞—è –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—è –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏ (quaternion)
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–æ—á–Ω–æ–µ –≤—Ä–µ–º—è `frame_stamp` –¥–ª—è –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏–∏

‚ö†Ô∏è **–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ**: –î–ª—è quaternion –∂–µ–ª–∞—Ç–µ–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å SLERP (—Å—Ñ–µ—Ä–∏—á–µ—Å–∫—É—é –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—é), –Ω–æ –¥–ª—è –º–∞–ª—ã—Ö –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤ –≤—Ä–µ–º–µ–Ω–∏ –ª–∏–Ω–µ–π–Ω–∞—è –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—è –ø—Ä–∏–µ–º–ª–µ–º–∞.

### 4. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
- –≠–∫—Å–ø–æ—Ä—Ç –≤ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã
- –ò–º–µ–Ω–∞ —Ñ–∞–π–ª–æ–≤: `{bag_name}_camera_positions.{ext}`

## –ü—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞

```
üöÄ –ù–ê–ß–ê–õ–û –ò–ó–í–õ–ï–ß–ï–ù–ò–Ø –ü–û–ó–ò–¶–ò–ô –ö–ê–ú–ï–†–´
================================================================================
üì¶ –ò–ó–í–õ–ï–ß–ï–ù–ò–ï –î–ê–ù–ù–´–• –ò–ó BAG –§–ê–ô–õ–ê
================================================================================

üìã –°—Ç–∞—Ç—É—Å —Ç–æ–ø–∏–∫–æ–≤:
  /mavros/cam_imu_sync/cam_imu_stamp: ‚úÖ –ù–ê–ô–î–ï–ù
  /mavros/statustext/send: ‚úÖ –ù–ê–ô–î–ï–ù
  /mavros/local_position/odom: ‚úÖ –ù–ê–ô–î–ï–ù

üìñ –ß—Ç–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π...

‚úÖ –ò–∑–≤–ª–µ—á–µ–Ω–æ –¥–∞–Ω–Ω—ã—Ö:
   üì∏ –ú–µ—Ç–æ–∫ –∫–∞–º–µ—Ä—ã: 2
   üìù –ò–º—ë–Ω —Ñ–∞–π–ª–æ–≤: 2
   üéØ –ü–æ–∑–∏—Ü–∏–π –æ–¥–æ–º–µ—Ç—Ä–∏–∏: 6332

üîó –°–û–ü–û–°–¢–ê–í–õ–ï–ù–ò–ï –ö–ê–î–†–û–í –° –ò–ú–ï–ù–ê–ú–ò –§–ê–ô–õ–û–í
================================================================================

üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è:
   ‚úÖ –°–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–æ: 2
   ‚ö†Ô∏è  –ù–µ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–æ: 0
   üìà –°—Ä–µ–¥–Ω—è—è —Ä–∞–∑–Ω–∏—Ü–∞ –≤—Ä–µ–º–µ–Ω–∏: 403.16 –º—Å
   üìà –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Ä–∞–∑–Ω–∏—Ü–∞: 771.93 –º—Å

üéØ –ò–ù–¢–ï–†–ü–û–õ–Ø–¶–ò–Ø –ü–û–ó–ò–¶–ò–ô
================================================================================

‚úÖ –ò–Ω—Ç–µ—Ä–ø–æ–ª–∏—Ä–æ–≤–∞–Ω–æ –ø–æ–∑–∏—Ü–∏–π: 2

üíæ –°–û–•–†–ê–ù–ï–ù–ò–ï –†–ï–ó–£–õ–¨–¢–ê–¢–û–í
================================================================================

üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ CSV: ./test_camera_positions.csv
   ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ 2 –ø–æ–∑–∏—Ü–∏–π

üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ JSON: ./test_camera_positions.json
   ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ 2 –ø–æ–∑–∏—Ü–∏–π

üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ Agisoft TXT: ./test_camera_positions_agisoft.txt
   ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ 2 –ø–æ–∑–∏—Ü–∏–π

‚úÖ –ò–ó–í–õ–ï–ß–ï–ù–ò–ï –ó–ê–í–ï–†–®–ï–ù–û –£–°–ü–ï–®–ù–û!
```

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ Agisoft Metashape

1. –û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–æ–µ–∫—Ç –≤ Agisoft Metashape
2. –ò–º–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏
3. File ‚Üí Import ‚Üí Import Cameras...
4. –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª `*_camera_positions_agisoft.txt`
5. –£–∫–∞–∂–∏—Ç–µ —Ñ–æ—Ä–º–∞—Ç: Custom (filename x y z qx qy qz qw)
6. –ì–æ—Ç–æ–≤–æ! –ö–∞–º–µ—Ä—ã –ø–æ–ª—É—á–∞—Ç –ø–æ–∑–∏—Ü–∏–∏ –∏–∑ —Ñ–∞–π–ª–∞

## –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

- Python 3.x
- rosbag
- numpy
- scipy

## –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –Ω–µ–ø–æ–ª–∞–¥–æ–∫

### –û—à–∏–±–∫–∞: "–ù–µ –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Ç–æ–ø–∏–∫–∏ –Ω–∞–π–¥–µ–Ω—ã"
**–†–µ—à–µ–Ω–∏–µ**: –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ bag —Ñ–∞–π–ª —Å–æ–¥–µ—Ä–∂–∏—Ç –≤—Å–µ —Ç—Ä–∏ —Ç–æ–ø–∏–∫–∞. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `camera_frames_debug.py` –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞.

### –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: "–ù–µ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–æ: N –∫–∞–¥—Ä–æ–≤"
**–ü—Ä–∏—á–∏–Ω–∞**: –ù–µ—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π `[PHOTO]:` –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö 1 —Å–µ–∫—É–Ω–¥—ã.
**–†–µ—à–µ–Ω–∏–µ**: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏, –≤–æ–∑–º–æ–∂–Ω–æ –∏–º–µ–Ω–∞ —Ñ–∞–π–ª–æ–≤ –ø—É–±–ª–∏–∫—É—é—Ç—Å—è –≤ –¥—Ä—É–≥–æ–º —Ç–æ–ø–∏–∫–µ.

### –û—à–∏–±–∫–∞ –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏–∏
**–ü—Ä–∏—á–∏–Ω–∞**: –í—Ä–µ–º—è –∫–∞–¥—Ä–∞ –≤–Ω–µ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ –æ–¥–æ–º–µ—Ç—Ä–∏–∏.
**–†–µ—à–µ–Ω–∏–µ**: –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∑–∞–ø–∏—Å—å –æ–¥–æ–º–µ—Ç—Ä–∏–∏ –Ω–∞—á–∞–ª–∞—Å—å –¥–æ –ø–µ—Ä–≤–æ–≥–æ –∫–∞–¥—Ä–∞ –∏ –∑–∞–∫–æ–Ω—á–∏–ª–∞—Å—å –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ.

## –°–≤—è–∑–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

- `camera_frames_debug.py` - –æ—Ç–ª–∞–¥–æ—á–Ω—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Å–æ–æ–±—â–µ–Ω–∏–π
- `doc/CAMERA_FRAMES_DEBUG_README.md` - –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ –æ—Ç–ª–∞–¥–∫–µ

## –ê–≤—Ç–æ—Ä

–ß–∞—Å—Ç—å –ø—Ä–æ–µ–∫—Ç–∞ rosbag_to_las
